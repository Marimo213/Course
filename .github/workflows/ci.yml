name: Build and Deploy Game

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Проверка кода
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Настройка Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3. Авторизация на сервере (SSH)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 4. Собираем образы локально (для пуша)
      - name: Build server image
        run: docker build -t mp-ws-server:latest ./server

      - name: Build client image
        run: docker build -t mp-web-client:latest ./client

      # 5. Копируем файлы на сервер
      - name: Copy files to server
        run: |
          rsync -avz --exclude .git ./ user@SERVER_IP:/home/user/game/

      # 6. Деплой на сервере
      - name: Deploy via Swarm
        run: |
          ssh user@SERVER_IP "
          cd /home/user/game;
          docker build -t mp-ws-server:latest ./server;
          docker build -t mp-web-client:latest ./client;
          docker stack deploy -c stack.yml game
          "
